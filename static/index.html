<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cover Letter Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af' }
          }
        }
      }
    }
  </script>
  <style>
    /* spinner */
    .spinner{border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;width:1.25rem;height:1.25rem;animation:spin .6s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* scrollbar */
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    /* transition for toast */
    .toast{animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateY(-1rem);opacity:0}to{transform:translateY(0);opacity:1}}
    /* markdown-ish line spacing in cover letter */
    #coverLetterArea{line-height:1.7;font-family:'Segoe UI',system-ui,sans-serif}
    /* drag highlight */
    .drag-over{border-color:#3b82f6 !important;background:#eff6ff !important}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

<!-- ── Toast container ──────────────────────────────────────────── -->
<div id="toasts" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<!-- ── Header ───────────────────────────────────────────────────── -->
<header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shadow-sm">
  <div class="flex items-center gap-3">
    <div class="bg-brand-600 text-white rounded-lg p-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
    </div>
    <h1 class="text-xl font-bold text-gray-900">Cover Letter Agent</h1>
  </div>
  <span class="text-xs text-gray-400">Powered by GPT-4o</span>
</header>

<!-- ── Main grid ────────────────────────────────────────────────── -->
<main class="flex-1 grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-0 overflow-hidden" style="height:calc(100vh - 65px)">

  <!-- ── LEFT SIDEBAR ────────────────────────────────────────────── -->
  <aside class="bg-white border-r border-gray-200 p-5 flex flex-col gap-5 overflow-y-auto">

    <!-- Resume upload -->
    <section>
      <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Resume (PDF)</h2>
      <div id="resumeDropZone"
           class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-brand-500 transition">
        <input type="file" id="resumeInput" accept=".pdf" class="hidden" />
        <svg class="mx-auto w-8 h-8 text-gray-400 mb-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
        <p class="text-sm text-gray-500">Drag &amp; drop or <span class="text-brand-600 font-medium">browse</span></p>
      </div>
      <div id="resumeStatus" class="mt-2 text-sm hidden"></div>
    </section>

    <!-- Cover letters upload -->
    <section>
      <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Cover Letters (DOCX)</h2>
      <div id="coverDropZone"
           class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-brand-500 transition">
        <input type="file" id="coverInput" accept=".docx" multiple class="hidden" />
        <svg class="mx-auto w-8 h-8 text-gray-400 mb-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
        <p class="text-sm text-gray-500">Drag &amp; drop or <span class="text-brand-600 font-medium">browse</span> (multiple)</p>
      </div>
      <div id="coverStatus" class="mt-2 text-sm hidden"></div>
    </section>

    <hr class="border-gray-200"/>

    <!-- Job description -->
    <section class="flex-1 flex flex-col">
      <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Job Description</h2>
      <textarea id="jdInput" rows="12"
        class="flex-1 w-full border border-gray-300 rounded-lg p-3 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
        placeholder="Paste the full job description here…"></textarea>

      <button id="generateBtn"
        class="mt-3 w-full bg-brand-600 hover:bg-brand-700 text-white font-medium py-2.5 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        disabled>
        <span id="genBtnText">Generate Cover Letter</span>
        <span id="genSpinner" class="spinner hidden"></span>
      </button>
    </section>
  </aside>

  <!-- ── RIGHT PANEL ──────────────────────────────────────────────── -->
  <div class="flex flex-col overflow-hidden">

    <!-- Cover letter output area -->
    <div class="flex-1 overflow-y-auto p-6">

      <!-- Placeholder when no letter generated yet -->
      <div id="placeholder" class="flex flex-col items-center justify-center h-full text-gray-400">
        <svg class="w-16 h-16 mb-3" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
        <p class="text-lg font-medium">Your cover letter will appear here</p>
        <p class="text-sm mt-1">Upload your documents, paste a job description, and click Generate</p>
      </div>

      <!-- Results container (hidden initially) -->
      <div id="resultsContainer" class="hidden space-y-4">

        <!-- Agent message -->
        <div id="agentMsgCard" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-blue-500 mt-0.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
            <div>
              <p class="text-xs font-semibold text-blue-700 uppercase mb-1">Agent Notes</p>
              <p id="agentMsg" class="text-sm text-blue-900 whitespace-pre-wrap"></p>
            </div>
          </div>
        </div>

        <!-- Cover letter -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <div class="flex items-center justify-between border-b border-gray-100 px-4 py-2">
            <span class="text-sm font-semibold text-gray-700">Cover Letter</span>
            <button id="copyBtn" title="Copy to clipboard"
              class="text-gray-400 hover:text-brand-600 transition p-1 rounded">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/></svg>
            </button>
          </div>
          <textarea id="coverLetterArea"
            class="w-full p-5 text-sm min-h-[300px] resize-y focus:outline-none"
            placeholder="Generated cover letter will appear here…"></textarea>
        </div>

        <!-- Chat history -->
        <div id="chatHistory" class="space-y-3"></div>
      </div>
    </div>

    <!-- ── Bottom feedback bar ────────────────────────────────────── -->
    <div id="feedbackBar" class="border-t border-gray-200 bg-white p-4 hidden">
      <div class="flex gap-2">
        <input id="feedbackInput" type="text"
          class="flex-1 border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
          placeholder="Give feedback or request changes…" />
        <button id="editBtn"
          class="bg-brand-600 hover:bg-brand-700 text-white font-medium py-2.5 px-5 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <span id="editBtnText">Request Changes</span>
          <span id="editSpinner" class="spinner hidden"></span>
        </button>
      </div>
    </div>
  </div>
</main>

<!-- ═══════════════════ JAVASCRIPT ═══════════════════════════════ -->
<script>
const API = '';  // same origin

// ── DOM refs ────────────────────────────────────────────────────
const resumeInput    = document.getElementById('resumeInput');
const resumeDropZone = document.getElementById('resumeDropZone');
const resumeStatus   = document.getElementById('resumeStatus');
const coverInput     = document.getElementById('coverInput');
const coverDropZone  = document.getElementById('coverDropZone');
const coverStatus    = document.getElementById('coverStatus');
const jdInput        = document.getElementById('jdInput');
const generateBtn    = document.getElementById('generateBtn');
const genBtnText     = document.getElementById('genBtnText');
const genSpinner     = document.getElementById('genSpinner');
const placeholder    = document.getElementById('placeholder');
const resultsContainer = document.getElementById('resultsContainer');
const agentMsgCard   = document.getElementById('agentMsgCard');
const agentMsg       = document.getElementById('agentMsg');
const coverLetterArea= document.getElementById('coverLetterArea');
const copyBtn        = document.getElementById('copyBtn');
const feedbackBar    = document.getElementById('feedbackBar');
const feedbackInput  = document.getElementById('feedbackInput');
const editBtn        = document.getElementById('editBtn');
const editBtnText    = document.getElementById('editBtnText');
const editSpinner    = document.getElementById('editSpinner');
const chatHistory    = document.getElementById('chatHistory');

// ── Toast helper ────────────────────────────────────────────────
function toast(msg, type='success') {
  const el = document.createElement('div');
  const colors = {success:'bg-green-500', error:'bg-red-500', info:'bg-blue-500'};
  el.className = `toast text-white text-sm px-4 py-2 rounded-lg shadow-lg ${colors[type]||colors.info}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ── Status badge helper ─────────────────────────────────────────
function setStatus(el, msg, ok) {
  el.classList.remove('hidden');
  el.innerHTML = ok
    ? `<span class="inline-flex items-center gap-1 text-green-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>${msg}</span>`
    : `<span class="inline-flex items-center gap-1 text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>${msg}</span>`;
}

// ── Enable generate button when JD is entered ────────────────────
jdInput.addEventListener('input', () => {
  generateBtn.disabled = !jdInput.value.trim();
});

// ── Drag-and-drop helpers ───────────────────────────────────────
function setupDrop(zone, input) {
  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    input.files = e.dataTransfer.files;
    input.dispatchEvent(new Event('change'));
  });
}
setupDrop(resumeDropZone, resumeInput);
setupDrop(coverDropZone, coverInput);

// ── Upload resume ───────────────────────────────────────────────
resumeInput.addEventListener('change', async () => {
  const file = resumeInput.files[0];
  if (!file) return;
  setStatus(resumeStatus, 'Uploading & embedding…', true);

  const fd = new FormData();
  fd.append('file', file);

  try {
    const res = await fetch(`${API}/api/upload-resume`, { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    setStatus(resumeStatus, `Embedded: ${data.filename}`, true);
    toast('Resume uploaded & embedded');
  } catch (err) {
    setStatus(resumeStatus, err.message, false);
    toast(err.message, 'error');
  }
});

// ── Upload cover letters ────────────────────────────────────────
coverInput.addEventListener('change', async () => {
  const files = coverInput.files;
  if (!files.length) return;
  setStatus(coverStatus, 'Uploading & embedding…', true);

  const fd = new FormData();
  for (const f of files) fd.append('files', f);

  try {
    const res = await fetch(`${API}/api/upload-cover-letters`, { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    setStatus(coverStatus, `Embedded ${data.count} file(s)`, true);
    toast(`${data.count} cover letter(s) embedded`);
  } catch (err) {
    setStatus(coverStatus, err.message, false);
    toast(err.message, 'error');
  }
});

// ── Show results ────────────────────────────────────────────────
function showResults(coverLetter, message) {
  placeholder.classList.add('hidden');
  resultsContainer.classList.remove('hidden');
  feedbackBar.classList.remove('hidden');

  coverLetterArea.value = coverLetter || '';

  if (message && message.trim()) {
    agentMsgCard.classList.remove('hidden');
    agentMsg.textContent = message;
  } else {
    agentMsgCard.classList.add('hidden');
  }
}

// ── Add chat bubble ─────────────────────────────────────────────
function addChatBubble(text, role) {
  const wrapper = document.createElement('div');
  wrapper.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = role === 'user'
    ? 'bg-brand-600 text-white rounded-xl rounded-br-sm px-4 py-2 text-sm max-w-[80%] whitespace-pre-wrap'
    : 'bg-gray-100 text-gray-800 rounded-xl rounded-bl-sm px-4 py-2 text-sm max-w-[80%] whitespace-pre-wrap';
  bubble.textContent = text;

  wrapper.appendChild(bubble);
  chatHistory.appendChild(wrapper);
  wrapper.scrollIntoView({ behavior: 'smooth' });
}

// ── Generate cover letter ───────────────────────────────────────
generateBtn.addEventListener('click', async () => {
  const jd = jdInput.value.trim();
  if (!jd) return;

  generateBtn.disabled = true;
  genBtnText.textContent = 'Generating…';
  genSpinner.classList.remove('hidden');
  chatHistory.innerHTML = '';

  try {
    const res = await fetch(`${API}/api/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ job_description: jd }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    showResults(data.cover_letter, data.message);
    toast('Cover letter generated!');
  } catch (err) {
    toast(err.message, 'error');
  } finally {
    generateBtn.disabled = false;
    genBtnText.textContent = 'Generate Cover Letter';
    genSpinner.classList.add('hidden');
  }
});

// ── Request changes (edit) ──────────────────────────────────────
async function requestEdit() {
  const feedback = feedbackInput.value.trim();
  if (!feedback) return;

  editBtn.disabled = true;
  editBtnText.textContent = 'Updating…';
  editSpinner.classList.remove('hidden');

  addChatBubble(feedback, 'user');
  feedbackInput.value = '';

  try {
    const res = await fetch(`${API}/api/edit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        feedback,
        cover_letter: coverLetterArea.value,
      }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    coverLetterArea.value = data.cover_letter || '';

    if (data.message && data.message.trim()) {
      addChatBubble(data.message, 'agent');
      agentMsg.textContent = data.message;
      agentMsgCard.classList.remove('hidden');
    }

    toast('Cover letter updated');
  } catch (err) {
    toast(err.message, 'error');
  } finally {
    editBtn.disabled = false;
    editBtnText.textContent = 'Request Changes';
    editSpinner.classList.add('hidden');
  }
}

editBtn.addEventListener('click', requestEdit);
feedbackInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); requestEdit(); }
});

// ── Copy to clipboard ───────────────────────────────────────────
copyBtn.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(coverLetterArea.value);
    toast('Copied to clipboard');
  } catch {
    // fallback
    coverLetterArea.select();
    document.execCommand('copy');
    toast('Copied to clipboard');
  }
});
</script>
</body>
</html>
